<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Backend - Smart Bus Stop</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Teste do Backend - Smart Bus Stop</h1>
        
        <!-- Status de Conex√£o -->
        <div id="connectionStatus" class="mb-6 p-4 rounded-lg border">
            <h2 class="text-xl font-semibold mb-2">Status da Conex√£o</h2>
            <div id="statusContent">Clique em "Testar Conex√£o" para verificar</div>
        </div>

        <!-- Bot√µes de Teste B√°sico -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <button onclick="testConnection()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Testar Conex√£o
            </button>
            <button onclick="testThingSpeak()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                Testar ThingSpeak
            </button>
            <button onclick="testRegister()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                Testar Registro
            </button>
            <button onclick="testLogin()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                Testar Login
            </button>
        </div>

        <!-- Bot√µes de Teste Analytics -->
        <h3 class="text-lg font-semibold mb-4">üî¨ Testes de Analytics</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
            <button onclick="testDashboard()" class="bg-emerald-500 text-white px-3 py-2 rounded text-sm hover:bg-emerald-600">
                Dashboard
            </button>
            <button onclick="testReadings()" class="bg-cyan-500 text-white px-3 py-2 rounded text-sm hover:bg-cyan-600">
                Readings
            </button>
            <button onclick="testSummary()" class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600">
                Summary
            </button>
            <button onclick="testTrends()" class="bg-pink-500 text-white px-3 py-2 rounded text-sm hover:bg-pink-600">
                Trends
            </button>
            <button onclick="testDataQuality()" class="bg-yellow-500 text-white px-3 py-2 rounded text-sm hover:bg-yellow-600">
                Data Quality
            </button>
        </div>

        <!-- Log de Resultados -->
        <div class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm h-96 overflow-y-auto">
            <div id="logOutput">Logs aparecer√£o aqui...</div>
        </div>

        <!-- Dados em Tempo Real -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-semibold mb-2">Temperatura</h3>
                <div id="tempDisplay" class="text-2xl font-bold text-blue-600">-- ¬∞C</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-semibold mb-2">Umidade</h3>
                <div id="humDisplay" class="text-2xl font-bold text-green-600">-- %</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "https://back-smart-bus-iot-nyp0.onrender.com";
        const logOutput = document.getElementById('logOutput');
        const statusContent = document.getElementById('statusContent');
        const tempDisplay = document.getElementById('tempDisplay');
        const humDisplay = document.getElementById('humDisplay');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                success: 'text-blue-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-green-400';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        async function testConnection() {
            log('üîÑ Testando conex√£o b√°sica...', 'info');
            statusContent.innerHTML = '<span class="text-yellow-600">Testando...</span>';
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`‚úÖ Resposta recebida: ${response.status} ${response.statusText}`, 'success');
                statusContent.innerHTML = `<span class="text-green-600">‚úÖ Conectado (${response.status})</span>`;
                
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                statusContent.innerHTML = `<span class="text-red-600">‚ùå Desconectado: ${error.message}</span>`;
            }
        }

        async function testThingSpeak() {
            log('üîÑ Testando endpoint ThingSpeak...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/sensors/test_thingspeak`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üì° Status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`üìä Dados recebidos: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    // Atualizar displays
                    if (data.temperature !== undefined) {
                        tempDisplay.textContent = `${data.temperature} ¬∞C`;
                    }
                    if (data.humidity !== undefined) {
                        humDisplay.textContent = `${data.humidity} %`;
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Erro: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
            }
        }

        async function testRegister() {
            log('üîÑ Testando registro de usu√°rio...', 'info');
            
            const testUser = {
                email: `test${Date.now()}@example.com`,
                password: "123456",
                full_name: "Usu√°rio Teste"
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testUser)
                });
                
                log(`üìù Status registro: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Usu√°rio registrado: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Erro no registro: ${JSON.stringify(errorData, null, 2)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o de registro: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            log('üîÑ Testando login...', 'info');
            
            const loginData = {
                email: "test@example.com",
                password: "123456"
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                log(`üîê Status login: ${response.status}`, 'info');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Login realizado: Token recebido`, 'success');
                    localStorage.setItem('token', data.access_token);
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Erro no login: ${JSON.stringify(errorData, null, 2)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o de login: ${error.message}`, 'error');
            }
        }

        // Inicializa√ß√£o
        log('üöÄ P√°gina de teste carregada', 'info');
        log(`üîó Backend URL: ${BACKEND_URL}`, 'info');
        
        // Novos testes para endpoints de analytics
        async function testDashboard() {
            log('üîÑ Testando endpoint /api/analytics/dashboard...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/analytics/dashboard`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'fake-token'}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üìä Dashboard Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Dashboard data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Dashboard Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Dashboard Request Error: ${error.message}`, 'error');
            }
        }

        async function testReadings() {
            log('üîÑ Testando endpoint /api/sensors/readings...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/sensors/readings?limit=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'fake-token'}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üìà Readings Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Readings: ${data.readings?.length || 0} leituras encontradas`, 'success');
                    
                    if (data.readings && data.readings.length > 0) {
                        const latest = data.readings[0];
                        tempDisplay.textContent = `${latest.temperature || '--'} ¬∞C`;
                        humDisplay.textContent = `${latest.humidity || '--'} %`;
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Readings Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Readings Request Error: ${error.message}`, 'error');
            }
        }

        async function testSummary() {
            log('üîÑ Testando endpoint /api/analytics/summary...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/analytics/summary?timeframe=24h`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'fake-token'}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üìä Summary Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Summary data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Summary Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Summary Request Error: ${error.message}`, 'error');
            }
        }

        async function testTrends() {
            log('üîÑ Testando endpoint /api/analytics/trends...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/analytics/trends?days=7`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'fake-token'}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üìà Trends Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Trends data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Trends Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Trends Request Error: ${error.message}`, 'error');
            }
        }

        async function testDataQuality() {
            log('üîÑ Testando endpoint /api/analytics/data-quality...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/analytics/data-quality`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'fake-token'}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üéØ Data Quality Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Data Quality: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Data Quality Error: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Data Quality Request Error: ${error.message}`, 'error');
            }
        }

        // Teste autom√°tico de conex√£o ao carregar
        setTimeout(testConnection, 1000);
        
        // Teste autom√°tico do ThingSpeak a cada 15 segundos
        setInterval(testThingSpeak, 15000);
    </script>
</body>
</html>
